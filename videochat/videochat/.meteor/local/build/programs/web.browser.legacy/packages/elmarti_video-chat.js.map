{"version":3,"sources":["meteor://ðŸ’»app/packages/elmarti:video-chat/meteor.js","meteor://ðŸ’»app/packages/elmarti:video-chat/lib/client.js","meteor://ðŸ’»app/packages/elmarti:video-chat/lib/index.js"],"names":["module","export","VideoCallServices","Meteor","link","v","MeteorClient","Tracker","ReactiveVar","CoreClient","client","MeteorVideoChat","ddp","connection","_stream","Streamer","streamHandlers","handleStreamCallSessionRemoved","callLog","terminateCall","handleStreamReceivingPhoneCall","msg","fields","_id","id","setCallLog","stream","on","handleTargetStream","bind","setState","localMuted","remoteMuted","inProgress","ringing","onReceiveCall","caller","handleStreamCallOwnCallSessionInitialized","handleCallerStream","handleStreamCalleeAccept","status","meteor","userId","core","handleTargetAccept","onTargetAccept","handleStreamCalleeRejected","onCallRejected","call","handleStreamCallFinished","handleStreamUpdates","undefined","args","tracker","reactiveVar","state","autorun","sub","subscribe","handleStream","Object","assign","JSON","parse","collection","target","streamData","offer","Direction","Type","data","candidate","getLocalVideo","localVideoWrapper","element","getElement","stateObject","oldState","get","set","getState","key","getRemoteVideo","remoteVideoWrapper","toggleLocalAudio","video","srcObject","getAudioTracks","forEach","track","enabled","toggleRemoteAudio","params","handleSenderStream","answer","message","answerCall","rejectCall","err","onError","endCall","init","rtcConfiguration","onTerminateCall","onPeerConnectionCreated","setOnError","callback","events","callEvent","iceCandidate","emit","stringify","sessionDescription","console","log","prototype"],"mappings":"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","file":"/packages/elmarti_video-chat.js","sourcesContent":["//jshint esversion: 6\nimport { Meteor } from 'meteor/meteor';\nimport { VideoCallServices as MeteorClient } from './lib/client';\nimport { Tracker } from \"meteor/tracker\";\nimport { ReactiveVar } from 'meteor/reactive-var'\nimport { client as CoreClient } from 'rtcfly';\nimport { MeteorVideoChat } from './lib';\n\n\nconst VideoCallServices = MeteorVideoChat({\n    Meteor,\n    MeteorClient,\n    Tracker,\n    CoreClient,\n    ReactiveVar,\n    ddp:Meteor.connection._stream,\n    Streamer:Meteor.Streamer\n});\n\nexport {\n    VideoCallServices\n}\n","const streamHandlers = {\n    handleStreamCallSessionRemoved() {\n        this.callLog = null;\n        this.terminateCall();\n    },\n    handleStreamReceivingPhoneCall(msg) {\n        msg.fields._id = msg.id;\n        this.setCallLog(msg.fields);\n        this.stream = new this.Streamer(msg.id);\n        this.stream.on('video_message', this.handleTargetStream.bind(this));\n        this.setState({\n            localMuted: false,\n            remoteMuted: false,\n            inProgress: false,\n            ringing: true\n        });\n        this.onReceiveCall(this.callLog.caller);\n    },\n    handleStreamCallOwnCallSessionInitialized(msg) {\n        msg.fields._id = msg.id;\n        this.setCallLog(msg.fields);\n        this.stream = new this.Streamer(msg.id);\n        this.stream.on('video_message', this.handleCallerStream.bind(this));\n    },\n    handleStreamCalleeAccept(msg) {\n\n        if (msg.fields.status === 'ACCEPTED' &&\n            this.callLog.caller === this.meteor.userId()) {\n            this.setCallLog(msg.fields);\n            this.core.handleTargetAccept();\n            this.setState({\n                localMuted: false,\n                remoteMuted: false,\n                inProgress: true,\n                ringing: false\n            });\n            this.onTargetAccept();\n        }\n    },\n    handleStreamCalleeRejected(msg) {\n        if (msg.fields.status === 'REJECTED' && this.callLog.caller === this.meteor.userId()) {\n            this.setCallLog(msg.fields);\n            this.onCallRejected();\n            this.meteor.call(\"VideoCallServices/ackReject\", msg.id);\n        }\n    },\n    handleStreamCallFinished(msg) {\n        if (msg.fields.status === 'FINISHED') {\n            if (this.callLog.caller !== this.meteor.userId() || this.callLog.status !== \"REJECTED\") {\n                this.terminateCall();\n            }\n            this.callLog = null;\n        }\n    },\n    handleStreamUpdates(msg) {\n        if (msg.fields !== undefined) {\n            streamHandlers.handleStreamCalleeAccept.call(this, msg);\n            streamHandlers.handleStreamCalleeRejected.call(this, msg);\n            streamHandlers.handleStreamCallFinished.call(this, msg);\n        }\n    }\n};\n\n\n//jshint esversion: 6\nclass VideoCallServices {\n\n    constructor(args) {\n\n        let { meteor, tracker, core, reactiveVar, ddp, Streamer } = args;\n        this.meteor = meteor;\n        this.core = core;\n        this.ddp = ddp;\n        this.Streamer = Streamer;\n        this.state = new reactiveVar({\n            localMuted: false,\n            remoteMuted: false,\n            ringing: false,\n            inProgress: false\n        });\n\n\n        this.callLog = null;\n        tracker.autorun(() => {\n            this.sub = this.meteor.subscribe('VideoChatPublication');\n        });\n        this.ddp.on('message', this.handleStream.bind(this));\n\n\n    }\n    setCallLog(fields) {\n        this.callLog = Object.assign({}, this.callLog, fields);\n    }\n\n    /**\n     * Handle the Video chat specific data in the DDP stream\n     * @param msg {string}\n     */\n    handleStream(msg) {\n\n        msg = JSON.parse(msg);\n        if (msg.collection === 'VideoChatCallLog' &&\n            msg.msg === 'removed' && this.callLog !== null) {\n            streamHandlers.handleStreamCallSessionRemoved.call(this);\n        }\n        else if (msg.collection === 'VideoChatCallLog' &&\n            msg.msg === 'added' &&\n            msg.fields.target === this.meteor.userId() &&\n            msg.fields.status === \"NEW\") {\n            streamHandlers.handleStreamReceivingPhoneCall.call(this, msg);\n        }\n        else if (msg.collection === 'VideoChatCallLog' &&\n            msg.msg === 'added' &&\n            msg.fields.caller === this.meteor.userId() &&\n            msg.fields.status === 'NEW') {\n            streamHandlers.handleStreamCallOwnCallSessionInitialized.call(this, msg);\n        }\n        else if (msg.msg === 'changed' &&\n            msg.collection === 'VideoChatCallLog' &&\n            msg.fields !== undefined) {\n            streamHandlers.handleStreamUpdates.call(this, msg);\n        }\n    }\n\n    /**\n     * Handle the stream data for the target user\n     * @param streamData {string}\n     */\n    handleTargetStream(streamData) {\n        if (typeof streamData === \"string\") {\n            streamData = JSON.parse(streamData);\n        }\n        if (streamData.offer) {\n            this.core.handleTargetStream({\n                Direction: \"Target\",\n                Type: 1,\n                data: streamData.offer\n            });\n        }\n        if (streamData.candidate) {\n            if (typeof streamData.candidate === \"string\") {\n                streamData.candidate = JSON.parse(streamData.candidate);\n            }\n            this.core.handleTargetStream({\n                Direction: \"Target\",\n                Type: 0,\n                data: streamData.candidate\n            });\n\n        }\n    }\n\n\n    //I am aware that there is some repetition in the below 2 methods, \n    //Upon RTCFly v1 there will be a cleaner way of doing this and it will correctly return null\n\n\n    /**\n     * get the local video HTMLMediaElement\n     * @returns HTMLMediaElement | null\n     */\n    getLocalVideo() {\n        const localVideoWrapper = this.core.getLocalVideo();\n        if (localVideoWrapper !== undefined) {\n            const element = localVideoWrapper.getElement();\n            return element || null;\n        }\n        else {\n            return null;\n        }\n    }\n    /**\n     * Set a value on the application State\n     * @param state object, a key and value ie {localMuted:true}\n     */\n    setState(stateObject) {\n        const oldState = this.state.get();\n        this.state.set(Object.assign({}, oldState, stateObject));\n    }\n\n    /**\n     * Get a state value by key \n     * @param key :string\n     * @returns any\n     */\n    getState(key) {\n        const state = this.state.get();\n        return state[key];\n    }\n    /**\n     * get the remote video HTMLMediaElement\n     * @returns HTMLMediaElement | null\n     */\n    getRemoteVideo() {\n        const remoteVideoWrapper = this.core.getRemoteVideo();\n        if (remoteVideoWrapper !== undefined) {\n            const element = remoteVideoWrapper.getElement();\n            return element || null;\n        }\n        else {\n            return null;\n        }\n    }\n\n    toggleLocalAudio() {\n        const video = this.getLocalVideo();\n        if (video) {\n            video.srcObject.getAudioTracks().forEach(track => {\n                track.enabled = !track.enabled;\n                this.setState({\n                    localMuted: !track.enabled\n                });\n            });\n        }\n    }\n\n    toggleRemoteAudio() {\n        const video = this.getRemoteVideo();\n        if (video) {\n            video.srcObject.getAudioTracks().forEach(track => {\n                track.enabled = !track.enabled;\n                this.setState({\n                    remoteMuted: !track.enabled\n                });\n            });\n        }\n    }\n\n\n    /**\n     * Call allows you to call a remote user using their userId\n     * @param params {ICallParams}\n     */\n    call(params) {\n        this.core.call(params);\n    }\n\n    /**\n     * Handle the data stream for the caller\n     * @param streamData {string}\n     */\n    handleCallerStream(streamData) {\n        if (typeof streamData === 'string') {\n            streamData = JSON.parse(streamData);\n        }\n\n        if (streamData.candidate) {\n            if (typeof streamData.candidate === 'string') {\n                streamData.candidate = JSON.parse(streamData.candidate);\n            }\n            this.core.handleSenderStream({\n                Direction: \"Sender\",\n                Type: 0,\n                data: streamData.candidate\n            });\n\n        }\n\n        if (streamData.answer) {\n            const message = {\n                data: streamData.answer,\n                Direction: \"Sender\",\n                Type: 1\n\n            };\n            this.core.handleSenderStream(message);\n        }\n    }\n\n    /**\n     * Answer the call\n     * @param params {ICallParams}\n     */\n    answerCall(params) {\n        this.core.answerCall(params);\n        this.setState({\n            localMuted: false,\n            remoteMuted: false,\n            inProgress: true,\n            ringing: false\n        });\n    }\n    /**\n     * Reject the phone call\n     */\n    rejectCall() {\n        this.meteor.call(\"VideoCallServices/reject\", err => {\n            if (err) {\n                this.onError(err);\n            }\n            this.core.rejectCall();\n            this.setState({\n                localMuted: false,\n                remoteMuted: false,\n                inProgress: false,\n                ringing: false\n            });\n        });\n    }\n    /**\n     * End the call\n     */\n    endCall() {\n        this.meteor.call(\"VideoCallServices/end\", err => {\n            if (err) {\n                this.onError(err);\n            }\n            this.terminateCall();\n        });\n    }\n    /**\n     * Initialize the local video chat client\n     * @param rtcConfiguration {RTCConfiguration}\n     * https://developer.mozilla.org/en-US/docs/Web/API/RTCConfiguration\n     */\n    init(rtcConfiguration) {\n        this.core.init(rtcConfiguration);\n    }\n    terminateCall() {\n        this.setState({\n            localMuted: false,\n            remoteMuted: false,\n            inProgress: false,\n            ringing: false\n        });\n        this.core.endCall();\n    }\n\n    onTargetAccept() {\n\n    }\n\n    onReceiveCall(fields) {\n\n    }\n\n    onTerminateCall() {\n\n    }\n    onPeerConnectionCreated() {\n\n    }\n    onCallRejected() {\n\n    }\n    setOnError(callback) {\n        this.core.on('error', callback);\n    }\n    onError(err) {\n        this.core.events.callEvent(\"error\")(err);\n    }\n    onReceiveCall() {\n\n    }\n\n\n}\n\nexport {\n    VideoCallServices\n};\n","export const MeteorVideoChat = ({\n    Meteor,\n    MeteorClient,\n    Tracker,\n    CoreClient,\n    ReactiveVar,\n    ddp,\n    Streamer\n}) => {\n\n\n        const core = new CoreClient({});\n        core.on('emitIceCandidate', iceCandidate =>\n            Meteor.VideoCallServices.stream.emit('video_message', JSON.stringify({ candidate: iceCandidate }))\n        );\n        core.on('emitTargetAnswer', answer =>\n            Meteor.VideoCallServices.stream.emit('video_message', JSON.stringify({ answer }))\n        );\n        core.on('callInitialized', (params) =>\n            Meteor.call('VideoCallServices/call', params.id,\n                (err, _id) => {})\n        );\n        core.on('endCall', () => {\n            Meteor.VideoCallServices.onTerminateCall();\n        });\n        core.on('answerCall', () => {\n            Meteor.call('VideoCallServices/answer', err => {\n                if (err) {\n                    core.events.callEvent(\"error\")(err);\n                }\n                Meteor.VideoCallServices.setState({\n                    localMuted: false,\n                    remoteMuted: false,\n                    inProgress: true,\n                    ringing: false\n                });\n            });\n        });\n        core.on('emitSenderDescription', sessionDescription =>\n            Meteor.VideoCallServices.stream.emit('video_message', JSON.stringify({ offer: sessionDescription }))\n        );\n        core.on('error', err => console.log(\"error\", err));\n\n        const VideoCallServices = new MeteorClient({\n            meteor: Meteor,\n            tracker: Tracker,\n            core,\n            reactiveVar: ReactiveVar,\n            ddp,\n            Streamer\n        });\n        Meteor.VideoCallServices = VideoCallServices;\n        core.on('recieveCall', VideoCallServices.onReceiveCall);\n        core.on('peerConnectionCreated', VideoCallServices.onPeerConnectionCreated);\n        Meteor.VideoCallServices.setOnError = function(onError) {\n            CoreClient.prototype.onError = onError;\n        };\n   \n        return VideoCallServices\n        \n    \n};\n"]}