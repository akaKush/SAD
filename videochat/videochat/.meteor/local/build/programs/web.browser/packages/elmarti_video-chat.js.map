{"version":3,"sources":["meteor://ðŸ’»app/packages/elmarti:video-chat/meteor.js","meteor://ðŸ’»app/packages/elmarti:video-chat/lib/client.js","meteor://ðŸ’»app/packages/elmarti:video-chat/lib/index.js"],"names":["module","export","VideoCallServices","Meteor","link","v","MeteorClient","Tracker","ReactiveVar","CoreClient","client","MeteorVideoChat","ddp","connection","_stream","Streamer","streamHandlers","handleStreamCallSessionRemoved","callLog","terminateCall","handleStreamReceivingPhoneCall","msg","fields","_id","id","setCallLog","stream","on","handleTargetStream","bind","setState","localMuted","remoteMuted","inProgress","ringing","onReceiveCall","caller","handleStreamCallOwnCallSessionInitialized","handleCallerStream","handleStreamCalleeAccept","status","meteor","userId","core","handleTargetAccept","onTargetAccept","handleStreamCalleeRejected","onCallRejected","call","handleStreamCallFinished","handleStreamUpdates","undefined","constructor","args","tracker","reactiveVar","state","autorun","sub","subscribe","handleStream","Object","assign","JSON","parse","collection","target","streamData","offer","Direction","Type","data","candidate","getLocalVideo","localVideoWrapper","element","getElement","stateObject","oldState","get","set","getState","key","getRemoteVideo","remoteVideoWrapper","toggleLocalAudio","video","srcObject","getAudioTracks","forEach","track","enabled","toggleRemoteAudio","params","handleSenderStream","answer","message","answerCall","rejectCall","err","onError","endCall","init","rtcConfiguration","onTerminateCall","onPeerConnectionCreated","setOnError","callback","events","callEvent","iceCandidate","emit","stringify","sessionDescription","console","log","prototype"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,mBAAiB,EAAC,MAAIA;AAAvB,CAAd;AAAyD,IAAIC,MAAJ;AAAWH,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACD,QAAM,CAACE,CAAD,EAAG;AAACF,UAAM,GAACE,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIC,YAAJ;AAAiBN,MAAM,CAACI,IAAP,CAAY,cAAZ,EAA2B;AAACF,mBAAiB,CAACG,CAAD,EAAG;AAACC,gBAAY,GAACD,CAAb;AAAe;;AAArC,CAA3B,EAAkE,CAAlE;AAAqE,IAAIE,OAAJ;AAAYP,MAAM,CAACI,IAAP,CAAY,gBAAZ,EAA6B;AAACG,SAAO,CAACF,CAAD,EAAG;AAACE,WAAO,GAACF,CAAR;AAAU;;AAAtB,CAA7B,EAAqD,CAArD;AAAwD,IAAIG,WAAJ;AAAgBR,MAAM,CAACI,IAAP,CAAY,qBAAZ,EAAkC;AAACI,aAAW,CAACH,CAAD,EAAG;AAACG,eAAW,GAACH,CAAZ;AAAc;;AAA9B,CAAlC,EAAkE,CAAlE;AAAqE,IAAII,UAAJ;AAAeT,MAAM,CAACI,IAAP,CAAY,QAAZ,EAAqB;AAACM,QAAM,CAACL,CAAD,EAAG;AAACI,cAAU,GAACJ,CAAX;AAAa;;AAAxB,CAArB,EAA+C,CAA/C;AAAkD,IAAIM,eAAJ;AAAoBX,MAAM,CAACI,IAAP,CAAY,OAAZ,EAAoB;AAACO,iBAAe,CAACN,CAAD,EAAG;AAACM,mBAAe,GAACN,CAAhB;AAAkB;;AAAtC,CAApB,EAA4D,CAA5D;AAS7b,MAAMH,iBAAiB,GAAGS,eAAe,CAAC;AACtCR,QADsC;AAEtCG,cAFsC;AAGtCC,SAHsC;AAItCE,YAJsC;AAKtCD,aALsC;AAMtCI,KAAG,EAACT,MAAM,CAACU,UAAP,CAAkBC,OANgB;AAOtCC,UAAQ,EAACZ,MAAM,CAACY;AAPsB,CAAD,CAAzC,C;;;;;;;;;;;ACTAf,MAAM,CAACC,MAAP,CAAc;AAACC,mBAAiB,EAAC,MAAIA;AAAvB,CAAd;AAAA,MAAMc,cAAc,GAAG;AACnBC,gCAA8B,GAAG;AAC7B,SAAKC,OAAL,GAAe,IAAf;AACA,SAAKC,aAAL;AACH,GAJkB;;AAKnBC,gCAA8B,CAACC,GAAD,EAAM;AAChCA,OAAG,CAACC,MAAJ,CAAWC,GAAX,GAAiBF,GAAG,CAACG,EAArB;AACA,SAAKC,UAAL,CAAgBJ,GAAG,CAACC,MAApB;AACA,SAAKI,MAAL,GAAc,IAAI,KAAKX,QAAT,CAAkBM,GAAG,CAACG,EAAtB,CAAd;AACA,SAAKE,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,KAAKC,kBAAL,CAAwBC,IAAxB,CAA6B,IAA7B,CAAhC;AACA,SAAKC,QAAL,CAAc;AACVC,gBAAU,EAAE,KADF;AAEVC,iBAAW,EAAE,KAFH;AAGVC,gBAAU,EAAE,KAHF;AAIVC,aAAO,EAAE;AAJC,KAAd;AAMA,SAAKC,aAAL,CAAmB,KAAKjB,OAAL,CAAakB,MAAhC;AACH,GAjBkB;;AAkBnBC,2CAAyC,CAAChB,GAAD,EAAM;AAC3CA,OAAG,CAACC,MAAJ,CAAWC,GAAX,GAAiBF,GAAG,CAACG,EAArB;AACA,SAAKC,UAAL,CAAgBJ,GAAG,CAACC,MAApB;AACA,SAAKI,MAAL,GAAc,IAAI,KAAKX,QAAT,CAAkBM,GAAG,CAACG,EAAtB,CAAd;AACA,SAAKE,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,KAAKW,kBAAL,CAAwBT,IAAxB,CAA6B,IAA7B,CAAhC;AACH,GAvBkB;;AAwBnBU,0BAAwB,CAAClB,GAAD,EAAM;AAE1B,QAAIA,GAAG,CAACC,MAAJ,CAAWkB,MAAX,KAAsB,UAAtB,IACA,KAAKtB,OAAL,CAAakB,MAAb,KAAwB,KAAKK,MAAL,CAAYC,MAAZ,EAD5B,EACkD;AAC9C,WAAKjB,UAAL,CAAgBJ,GAAG,CAACC,MAApB;AACA,WAAKqB,IAAL,CAAUC,kBAAV;AACA,WAAKd,QAAL,CAAc;AACVC,kBAAU,EAAE,KADF;AAEVC,mBAAW,EAAE,KAFH;AAGVC,kBAAU,EAAE,IAHF;AAIVC,eAAO,EAAE;AAJC,OAAd;AAMA,WAAKW,cAAL;AACH;AACJ,GAtCkB;;AAuCnBC,4BAA0B,CAACzB,GAAD,EAAM;AAC5B,QAAIA,GAAG,CAACC,MAAJ,CAAWkB,MAAX,KAAsB,UAAtB,IAAoC,KAAKtB,OAAL,CAAakB,MAAb,KAAwB,KAAKK,MAAL,CAAYC,MAAZ,EAAhE,EAAsF;AAClF,WAAKjB,UAAL,CAAgBJ,GAAG,CAACC,MAApB;AACA,WAAKyB,cAAL;AACA,WAAKN,MAAL,CAAYO,IAAZ,CAAiB,6BAAjB,EAAgD3B,GAAG,CAACG,EAApD;AACH;AACJ,GA7CkB;;AA8CnByB,0BAAwB,CAAC5B,GAAD,EAAM;AAC1B,QAAIA,GAAG,CAACC,MAAJ,CAAWkB,MAAX,KAAsB,UAA1B,EAAsC;AAClC,UAAI,KAAKtB,OAAL,CAAakB,MAAb,KAAwB,KAAKK,MAAL,CAAYC,MAAZ,EAAxB,IAAgD,KAAKxB,OAAL,CAAasB,MAAb,KAAwB,UAA5E,EAAwF;AACpF,aAAKrB,aAAL;AACH;;AACD,WAAKD,OAAL,GAAe,IAAf;AACH;AACJ,GArDkB;;AAsDnBgC,qBAAmB,CAAC7B,GAAD,EAAM;AACrB,QAAIA,GAAG,CAACC,MAAJ,KAAe6B,SAAnB,EAA8B;AAC1BnC,oBAAc,CAACuB,wBAAf,CAAwCS,IAAxC,CAA6C,IAA7C,EAAmD3B,GAAnD;AACAL,oBAAc,CAAC8B,0BAAf,CAA0CE,IAA1C,CAA+C,IAA/C,EAAqD3B,GAArD;AACAL,oBAAc,CAACiC,wBAAf,CAAwCD,IAAxC,CAA6C,IAA7C,EAAmD3B,GAAnD;AACH;AACJ;;AA5DkB,CAAvB,C,CAgEA;;AACA,MAAMnB,iBAAN,CAAwB;AAEpBkD,aAAW,CAACC,IAAD,EAAO;AAEd,QAAI;AAAEZ,YAAF;AAAUa,aAAV;AAAmBX,UAAnB;AAAyBY,iBAAzB;AAAsC3C,SAAtC;AAA2CG;AAA3C,QAAwDsC,IAA5D;AACA,SAAKZ,MAAL,GAAcA,MAAd;AACA,SAAKE,IAAL,GAAYA,IAAZ;AACA,SAAK/B,GAAL,GAAWA,GAAX;AACA,SAAKG,QAAL,GAAgBA,QAAhB;AACA,SAAKyC,KAAL,GAAa,IAAID,WAAJ,CAAgB;AACzBxB,gBAAU,EAAE,KADa;AAEzBC,iBAAW,EAAE,KAFY;AAGzBE,aAAO,EAAE,KAHgB;AAIzBD,gBAAU,EAAE;AAJa,KAAhB,CAAb;AAQA,SAAKf,OAAL,GAAe,IAAf;AACAoC,WAAO,CAACG,OAAR,CAAgB,MAAM;AAClB,WAAKC,GAAL,GAAW,KAAKjB,MAAL,CAAYkB,SAAZ,CAAsB,sBAAtB,CAAX;AACH,KAFD;AAGA,SAAK/C,GAAL,CAASe,EAAT,CAAY,SAAZ,EAAuB,KAAKiC,YAAL,CAAkB/B,IAAlB,CAAuB,IAAvB,CAAvB;AAGH;;AACDJ,YAAU,CAACH,MAAD,EAAS;AACf,SAAKJ,OAAL,GAAe2C,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAK5C,OAAvB,EAAgCI,MAAhC,CAAf;AACH;AAED;;;;;;AAIAsC,cAAY,CAACvC,GAAD,EAAM;AAEdA,OAAG,GAAG0C,IAAI,CAACC,KAAL,CAAW3C,GAAX,CAAN;;AACA,QAAIA,GAAG,CAAC4C,UAAJ,KAAmB,kBAAnB,IACA5C,GAAG,CAACA,GAAJ,KAAY,SADZ,IACyB,KAAKH,OAAL,KAAiB,IAD9C,EACoD;AAChDF,oBAAc,CAACC,8BAAf,CAA8C+B,IAA9C,CAAmD,IAAnD;AACH,KAHD,MAIK,IAAI3B,GAAG,CAAC4C,UAAJ,KAAmB,kBAAnB,IACL5C,GAAG,CAACA,GAAJ,KAAY,OADP,IAELA,GAAG,CAACC,MAAJ,CAAW4C,MAAX,KAAsB,KAAKzB,MAAL,CAAYC,MAAZ,EAFjB,IAGLrB,GAAG,CAACC,MAAJ,CAAWkB,MAAX,KAAsB,KAHrB,EAG4B;AAC7BxB,oBAAc,CAACI,8BAAf,CAA8C4B,IAA9C,CAAmD,IAAnD,EAAyD3B,GAAzD;AACH,KALI,MAMA,IAAIA,GAAG,CAAC4C,UAAJ,KAAmB,kBAAnB,IACL5C,GAAG,CAACA,GAAJ,KAAY,OADP,IAELA,GAAG,CAACC,MAAJ,CAAWc,MAAX,KAAsB,KAAKK,MAAL,CAAYC,MAAZ,EAFjB,IAGLrB,GAAG,CAACC,MAAJ,CAAWkB,MAAX,KAAsB,KAHrB,EAG4B;AAC7BxB,oBAAc,CAACqB,yCAAf,CAAyDW,IAAzD,CAA8D,IAA9D,EAAoE3B,GAApE;AACH,KALI,MAMA,IAAIA,GAAG,CAACA,GAAJ,KAAY,SAAZ,IACLA,GAAG,CAAC4C,UAAJ,KAAmB,kBADd,IAEL5C,GAAG,CAACC,MAAJ,KAAe6B,SAFd,EAEyB;AAC1BnC,oBAAc,CAACkC,mBAAf,CAAmCF,IAAnC,CAAwC,IAAxC,EAA8C3B,GAA9C;AACH;AACJ;AAED;;;;;;AAIAO,oBAAkB,CAACuC,UAAD,EAAa;AAC3B,QAAI,OAAOA,UAAP,KAAsB,QAA1B,EAAoC;AAChCA,gBAAU,GAAGJ,IAAI,CAACC,KAAL,CAAWG,UAAX,CAAb;AACH;;AACD,QAAIA,UAAU,CAACC,KAAf,EAAsB;AAClB,WAAKzB,IAAL,CAAUf,kBAAV,CAA6B;AACzByC,iBAAS,EAAE,QADc;AAEzBC,YAAI,EAAE,CAFmB;AAGzBC,YAAI,EAAEJ,UAAU,CAACC;AAHQ,OAA7B;AAKH;;AACD,QAAID,UAAU,CAACK,SAAf,EAA0B;AACtB,UAAI,OAAOL,UAAU,CAACK,SAAlB,KAAgC,QAApC,EAA8C;AAC1CL,kBAAU,CAACK,SAAX,GAAuBT,IAAI,CAACC,KAAL,CAAWG,UAAU,CAACK,SAAtB,CAAvB;AACH;;AACD,WAAK7B,IAAL,CAAUf,kBAAV,CAA6B;AACzByC,iBAAS,EAAE,QADc;AAEzBC,YAAI,EAAE,CAFmB;AAGzBC,YAAI,EAAEJ,UAAU,CAACK;AAHQ,OAA7B;AAMH;AACJ,GArFmB,CAwFpB;AACA;;AAGA;;;;;;AAIAC,eAAa,GAAG;AACZ,UAAMC,iBAAiB,GAAG,KAAK/B,IAAL,CAAU8B,aAAV,EAA1B;;AACA,QAAIC,iBAAiB,KAAKvB,SAA1B,EAAqC;AACjC,YAAMwB,OAAO,GAAGD,iBAAiB,CAACE,UAAlB,EAAhB;AACA,aAAOD,OAAO,IAAI,IAAlB;AACH,KAHD,MAIK;AACD,aAAO,IAAP;AACH;AACJ;AACD;;;;;;AAIA7C,UAAQ,CAAC+C,WAAD,EAAc;AAClB,UAAMC,QAAQ,GAAG,KAAKtB,KAAL,CAAWuB,GAAX,EAAjB;AACA,SAAKvB,KAAL,CAAWwB,GAAX,CAAenB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBgB,QAAlB,EAA4BD,WAA5B,CAAf;AACH;AAED;;;;;;;AAKAI,UAAQ,CAACC,GAAD,EAAM;AACV,UAAM1B,KAAK,GAAG,KAAKA,KAAL,CAAWuB,GAAX,EAAd;AACA,WAAOvB,KAAK,CAAC0B,GAAD,CAAZ;AACH;AACD;;;;;;AAIAC,gBAAc,GAAG;AACb,UAAMC,kBAAkB,GAAG,KAAKzC,IAAL,CAAUwC,cAAV,EAA3B;;AACA,QAAIC,kBAAkB,KAAKjC,SAA3B,EAAsC;AAClC,YAAMwB,OAAO,GAAGS,kBAAkB,CAACR,UAAnB,EAAhB;AACA,aAAOD,OAAO,IAAI,IAAlB;AACH,KAHD,MAIK;AACD,aAAO,IAAP;AACH;AACJ;;AAEDU,kBAAgB,GAAG;AACf,UAAMC,KAAK,GAAG,KAAKb,aAAL,EAAd;;AACA,QAAIa,KAAJ,EAAW;AACPA,WAAK,CAACC,SAAN,CAAgBC,cAAhB,GAAiCC,OAAjC,CAAyCC,KAAK,IAAI;AAC9CA,aAAK,CAACC,OAAN,GAAgB,CAACD,KAAK,CAACC,OAAvB;AACA,aAAK7D,QAAL,CAAc;AACVC,oBAAU,EAAE,CAAC2D,KAAK,CAACC;AADT,SAAd;AAGH,OALD;AAMH;AACJ;;AAEDC,mBAAiB,GAAG;AAChB,UAAMN,KAAK,GAAG,KAAKH,cAAL,EAAd;;AACA,QAAIG,KAAJ,EAAW;AACPA,WAAK,CAACC,SAAN,CAAgBC,cAAhB,GAAiCC,OAAjC,CAAyCC,KAAK,IAAI;AAC9CA,aAAK,CAACC,OAAN,GAAgB,CAACD,KAAK,CAACC,OAAvB;AACA,aAAK7D,QAAL,CAAc;AACVE,qBAAW,EAAE,CAAC0D,KAAK,CAACC;AADV,SAAd;AAGH,OALD;AAMH;AACJ;AAGD;;;;;;AAIA3C,MAAI,CAAC6C,MAAD,EAAS;AACT,SAAKlD,IAAL,CAAUK,IAAV,CAAe6C,MAAf;AACH;AAED;;;;;;AAIAvD,oBAAkB,CAAC6B,UAAD,EAAa;AAC3B,QAAI,OAAOA,UAAP,KAAsB,QAA1B,EAAoC;AAChCA,gBAAU,GAAGJ,IAAI,CAACC,KAAL,CAAWG,UAAX,CAAb;AACH;;AAED,QAAIA,UAAU,CAACK,SAAf,EAA0B;AACtB,UAAI,OAAOL,UAAU,CAACK,SAAlB,KAAgC,QAApC,EAA8C;AAC1CL,kBAAU,CAACK,SAAX,GAAuBT,IAAI,CAACC,KAAL,CAAWG,UAAU,CAACK,SAAtB,CAAvB;AACH;;AACD,WAAK7B,IAAL,CAAUmD,kBAAV,CAA6B;AACzBzB,iBAAS,EAAE,QADc;AAEzBC,YAAI,EAAE,CAFmB;AAGzBC,YAAI,EAAEJ,UAAU,CAACK;AAHQ,OAA7B;AAMH;;AAED,QAAIL,UAAU,CAAC4B,MAAf,EAAuB;AACnB,YAAMC,OAAO,GAAG;AACZzB,YAAI,EAAEJ,UAAU,CAAC4B,MADL;AAEZ1B,iBAAS,EAAE,QAFC;AAGZC,YAAI,EAAE;AAHM,OAAhB;AAMA,WAAK3B,IAAL,CAAUmD,kBAAV,CAA6BE,OAA7B;AACH;AACJ;AAED;;;;;;AAIAC,YAAU,CAACJ,MAAD,EAAS;AACf,SAAKlD,IAAL,CAAUsD,UAAV,CAAqBJ,MAArB;AACA,SAAK/D,QAAL,CAAc;AACVC,gBAAU,EAAE,KADF;AAEVC,iBAAW,EAAE,KAFH;AAGVC,gBAAU,EAAE,IAHF;AAIVC,aAAO,EAAE;AAJC,KAAd;AAMH;AACD;;;;;AAGAgE,YAAU,GAAG;AACT,SAAKzD,MAAL,CAAYO,IAAZ,CAAiB,0BAAjB,EAA6CmD,GAAG,IAAI;AAChD,UAAIA,GAAJ,EAAS;AACL,aAAKC,OAAL,CAAaD,GAAb;AACH;;AACD,WAAKxD,IAAL,CAAUuD,UAAV;AACA,WAAKpE,QAAL,CAAc;AACVC,kBAAU,EAAE,KADF;AAEVC,mBAAW,EAAE,KAFH;AAGVC,kBAAU,EAAE,KAHF;AAIVC,eAAO,EAAE;AAJC,OAAd;AAMH,KAXD;AAYH;AACD;;;;;AAGAmE,SAAO,GAAG;AACN,SAAK5D,MAAL,CAAYO,IAAZ,CAAiB,uBAAjB,EAA0CmD,GAAG,IAAI;AAC7C,UAAIA,GAAJ,EAAS;AACL,aAAKC,OAAL,CAAaD,GAAb;AACH;;AACD,WAAKhF,aAAL;AACH,KALD;AAMH;AACD;;;;;;;AAKAmF,MAAI,CAACC,gBAAD,EAAmB;AACnB,SAAK5D,IAAL,CAAU2D,IAAV,CAAeC,gBAAf;AACH;;AACDpF,eAAa,GAAG;AACZ,SAAKW,QAAL,CAAc;AACVC,gBAAU,EAAE,KADF;AAEVC,iBAAW,EAAE,KAFH;AAGVC,gBAAU,EAAE,KAHF;AAIVC,aAAO,EAAE;AAJC,KAAd;AAMA,SAAKS,IAAL,CAAU0D,OAAV;AACH;;AAEDxD,gBAAc,GAAG,CAEhB;;AAEDV,eAAa,CAACb,MAAD,EAAS,CAErB;;AAEDkF,iBAAe,GAAG,CAEjB;;AACDC,yBAAuB,GAAG,CAEzB;;AACD1D,gBAAc,GAAG,CAEhB;;AACD2D,YAAU,CAACC,QAAD,EAAW;AACjB,SAAKhE,IAAL,CAAUhB,EAAV,CAAa,OAAb,EAAsBgF,QAAtB;AACH;;AACDP,SAAO,CAACD,GAAD,EAAM;AACT,SAAKxD,IAAL,CAAUiE,MAAV,CAAiBC,SAAjB,CAA2B,OAA3B,EAAoCV,GAApC;AACH;;AACDhE,eAAa,GAAG,CAEf;;AAhSmB,C;;;;;;;;;;;ACjExBnC,MAAM,CAACC,MAAP,CAAc;AAACU,iBAAe,EAAC,MAAIA;AAArB,CAAd;;AAAO,MAAMA,eAAe,GAAG,UAQzB;AAAA,MAR0B;AAC5BR,UAD4B;AAE5BG,gBAF4B;AAG5BC,WAH4B;AAI5BE,cAJ4B;AAK5BD,eAL4B;AAM5BI,OAN4B;AAO5BG;AAP4B,GAQ1B;AAGE,QAAM4B,IAAI,GAAG,IAAIlC,UAAJ,CAAe,EAAf,CAAb;AACAkC,MAAI,CAAChB,EAAL,CAAQ,kBAAR,EAA4BmF,YAAY,IACpC3G,MAAM,CAACD,iBAAP,CAAyBwB,MAAzB,CAAgCqF,IAAhC,CAAqC,eAArC,EAAsDhD,IAAI,CAACiD,SAAL,CAAe;AAAExC,aAAS,EAAEsC;AAAb,GAAf,CAAtD,CADJ;AAGAnE,MAAI,CAAChB,EAAL,CAAQ,kBAAR,EAA4BoE,MAAM,IAC9B5F,MAAM,CAACD,iBAAP,CAAyBwB,MAAzB,CAAgCqF,IAAhC,CAAqC,eAArC,EAAsDhD,IAAI,CAACiD,SAAL,CAAe;AAAEjB;AAAF,GAAf,CAAtD,CADJ;AAGApD,MAAI,CAAChB,EAAL,CAAQ,iBAAR,EAA4BkE,MAAD,IACvB1F,MAAM,CAAC6C,IAAP,CAAY,wBAAZ,EAAsC6C,MAAM,CAACrE,EAA7C,EACI,CAAC2E,GAAD,EAAM5E,GAAN,KAAc,CAAE,CADpB,CADJ;AAIAoB,MAAI,CAAChB,EAAL,CAAQ,SAAR,EAAmB,MAAM;AACrBxB,UAAM,CAACD,iBAAP,CAAyBsG,eAAzB;AACH,GAFD;AAGA7D,MAAI,CAAChB,EAAL,CAAQ,YAAR,EAAsB,MAAM;AACxBxB,UAAM,CAAC6C,IAAP,CAAY,0BAAZ,EAAwCmD,GAAG,IAAI;AAC3C,UAAIA,GAAJ,EAAS;AACLxD,YAAI,CAACiE,MAAL,CAAYC,SAAZ,CAAsB,OAAtB,EAA+BV,GAA/B;AACH;;AACDhG,YAAM,CAACD,iBAAP,CAAyB4B,QAAzB,CAAkC;AAC9BC,kBAAU,EAAE,KADkB;AAE9BC,mBAAW,EAAE,KAFiB;AAG9BC,kBAAU,EAAE,IAHkB;AAI9BC,eAAO,EAAE;AAJqB,OAAlC;AAMH,KAVD;AAWH,GAZD;AAaAS,MAAI,CAAChB,EAAL,CAAQ,uBAAR,EAAiCsF,kBAAkB,IAC/C9G,MAAM,CAACD,iBAAP,CAAyBwB,MAAzB,CAAgCqF,IAAhC,CAAqC,eAArC,EAAsDhD,IAAI,CAACiD,SAAL,CAAe;AAAE5C,SAAK,EAAE6C;AAAT,GAAf,CAAtD,CADJ;AAGAtE,MAAI,CAAChB,EAAL,CAAQ,OAAR,EAAiBwE,GAAG,IAAIe,OAAO,CAACC,GAAR,CAAY,OAAZ,EAAqBhB,GAArB,CAAxB;AAEA,QAAMjG,iBAAiB,GAAG,IAAII,YAAJ,CAAiB;AACvCmC,UAAM,EAAEtC,MAD+B;AAEvCmD,WAAO,EAAE/C,OAF8B;AAGvCoC,QAHuC;AAIvCY,eAAW,EAAE/C,WAJ0B;AAKvCI,OALuC;AAMvCG;AANuC,GAAjB,CAA1B;AAQAZ,QAAM,CAACD,iBAAP,GAA2BA,iBAA3B;AACAyC,MAAI,CAAChB,EAAL,CAAQ,aAAR,EAAuBzB,iBAAiB,CAACiC,aAAzC;AACAQ,MAAI,CAAChB,EAAL,CAAQ,uBAAR,EAAiCzB,iBAAiB,CAACuG,uBAAnD;;AACAtG,QAAM,CAACD,iBAAP,CAAyBwG,UAAzB,GAAsC,UAASN,OAAT,EAAkB;AACpD3F,cAAU,CAAC2G,SAAX,CAAqBhB,OAArB,GAA+BA,OAA/B;AACH,GAFD;;AAIA,SAAOlG,iBAAP;AAGP,CA7DM,C","file":"/packages/elmarti_video-chat.js","sourcesContent":["//jshint esversion: 6\nimport { Meteor } from 'meteor/meteor';\nimport { VideoCallServices as MeteorClient } from './lib/client';\nimport { Tracker } from \"meteor/tracker\";\nimport { ReactiveVar } from 'meteor/reactive-var'\nimport { client as CoreClient } from 'rtcfly';\nimport { MeteorVideoChat } from './lib';\n\n\nconst VideoCallServices = MeteorVideoChat({\n    Meteor,\n    MeteorClient,\n    Tracker,\n    CoreClient,\n    ReactiveVar,\n    ddp:Meteor.connection._stream,\n    Streamer:Meteor.Streamer\n});\n\nexport {\n    VideoCallServices\n}\n","const streamHandlers = {\n    handleStreamCallSessionRemoved() {\n        this.callLog = null;\n        this.terminateCall();\n    },\n    handleStreamReceivingPhoneCall(msg) {\n        msg.fields._id = msg.id;\n        this.setCallLog(msg.fields);\n        this.stream = new this.Streamer(msg.id);\n        this.stream.on('video_message', this.handleTargetStream.bind(this));\n        this.setState({\n            localMuted: false,\n            remoteMuted: false,\n            inProgress: false,\n            ringing: true\n        });\n        this.onReceiveCall(this.callLog.caller);\n    },\n    handleStreamCallOwnCallSessionInitialized(msg) {\n        msg.fields._id = msg.id;\n        this.setCallLog(msg.fields);\n        this.stream = new this.Streamer(msg.id);\n        this.stream.on('video_message', this.handleCallerStream.bind(this));\n    },\n    handleStreamCalleeAccept(msg) {\n\n        if (msg.fields.status === 'ACCEPTED' &&\n            this.callLog.caller === this.meteor.userId()) {\n            this.setCallLog(msg.fields);\n            this.core.handleTargetAccept();\n            this.setState({\n                localMuted: false,\n                remoteMuted: false,\n                inProgress: true,\n                ringing: false\n            });\n            this.onTargetAccept();\n        }\n    },\n    handleStreamCalleeRejected(msg) {\n        if (msg.fields.status === 'REJECTED' && this.callLog.caller === this.meteor.userId()) {\n            this.setCallLog(msg.fields);\n            this.onCallRejected();\n            this.meteor.call(\"VideoCallServices/ackReject\", msg.id);\n        }\n    },\n    handleStreamCallFinished(msg) {\n        if (msg.fields.status === 'FINISHED') {\n            if (this.callLog.caller !== this.meteor.userId() || this.callLog.status !== \"REJECTED\") {\n                this.terminateCall();\n            }\n            this.callLog = null;\n        }\n    },\n    handleStreamUpdates(msg) {\n        if (msg.fields !== undefined) {\n            streamHandlers.handleStreamCalleeAccept.call(this, msg);\n            streamHandlers.handleStreamCalleeRejected.call(this, msg);\n            streamHandlers.handleStreamCallFinished.call(this, msg);\n        }\n    }\n};\n\n\n//jshint esversion: 6\nclass VideoCallServices {\n\n    constructor(args) {\n\n        let { meteor, tracker, core, reactiveVar, ddp, Streamer } = args;\n        this.meteor = meteor;\n        this.core = core;\n        this.ddp = ddp;\n        this.Streamer = Streamer;\n        this.state = new reactiveVar({\n            localMuted: false,\n            remoteMuted: false,\n            ringing: false,\n            inProgress: false\n        });\n\n\n        this.callLog = null;\n        tracker.autorun(() => {\n            this.sub = this.meteor.subscribe('VideoChatPublication');\n        });\n        this.ddp.on('message', this.handleStream.bind(this));\n\n\n    }\n    setCallLog(fields) {\n        this.callLog = Object.assign({}, this.callLog, fields);\n    }\n\n    /**\n     * Handle the Video chat specific data in the DDP stream\n     * @param msg {string}\n     */\n    handleStream(msg) {\n\n        msg = JSON.parse(msg);\n        if (msg.collection === 'VideoChatCallLog' &&\n            msg.msg === 'removed' && this.callLog !== null) {\n            streamHandlers.handleStreamCallSessionRemoved.call(this);\n        }\n        else if (msg.collection === 'VideoChatCallLog' &&\n            msg.msg === 'added' &&\n            msg.fields.target === this.meteor.userId() &&\n            msg.fields.status === \"NEW\") {\n            streamHandlers.handleStreamReceivingPhoneCall.call(this, msg);\n        }\n        else if (msg.collection === 'VideoChatCallLog' &&\n            msg.msg === 'added' &&\n            msg.fields.caller === this.meteor.userId() &&\n            msg.fields.status === 'NEW') {\n            streamHandlers.handleStreamCallOwnCallSessionInitialized.call(this, msg);\n        }\n        else if (msg.msg === 'changed' &&\n            msg.collection === 'VideoChatCallLog' &&\n            msg.fields !== undefined) {\n            streamHandlers.handleStreamUpdates.call(this, msg);\n        }\n    }\n\n    /**\n     * Handle the stream data for the target user\n     * @param streamData {string}\n     */\n    handleTargetStream(streamData) {\n        if (typeof streamData === \"string\") {\n            streamData = JSON.parse(streamData);\n        }\n        if (streamData.offer) {\n            this.core.handleTargetStream({\n                Direction: \"Target\",\n                Type: 1,\n                data: streamData.offer\n            });\n        }\n        if (streamData.candidate) {\n            if (typeof streamData.candidate === \"string\") {\n                streamData.candidate = JSON.parse(streamData.candidate);\n            }\n            this.core.handleTargetStream({\n                Direction: \"Target\",\n                Type: 0,\n                data: streamData.candidate\n            });\n\n        }\n    }\n\n\n    //I am aware that there is some repetition in the below 2 methods, \n    //Upon RTCFly v1 there will be a cleaner way of doing this and it will correctly return null\n\n\n    /**\n     * get the local video HTMLMediaElement\n     * @returns HTMLMediaElement | null\n     */\n    getLocalVideo() {\n        const localVideoWrapper = this.core.getLocalVideo();\n        if (localVideoWrapper !== undefined) {\n            const element = localVideoWrapper.getElement();\n            return element || null;\n        }\n        else {\n            return null;\n        }\n    }\n    /**\n     * Set a value on the application State\n     * @param state object, a key and value ie {localMuted:true}\n     */\n    setState(stateObject) {\n        const oldState = this.state.get();\n        this.state.set(Object.assign({}, oldState, stateObject));\n    }\n\n    /**\n     * Get a state value by key \n     * @param key :string\n     * @returns any\n     */\n    getState(key) {\n        const state = this.state.get();\n        return state[key];\n    }\n    /**\n     * get the remote video HTMLMediaElement\n     * @returns HTMLMediaElement | null\n     */\n    getRemoteVideo() {\n        const remoteVideoWrapper = this.core.getRemoteVideo();\n        if (remoteVideoWrapper !== undefined) {\n            const element = remoteVideoWrapper.getElement();\n            return element || null;\n        }\n        else {\n            return null;\n        }\n    }\n\n    toggleLocalAudio() {\n        const video = this.getLocalVideo();\n        if (video) {\n            video.srcObject.getAudioTracks().forEach(track => {\n                track.enabled = !track.enabled;\n                this.setState({\n                    localMuted: !track.enabled\n                });\n            });\n        }\n    }\n\n    toggleRemoteAudio() {\n        const video = this.getRemoteVideo();\n        if (video) {\n            video.srcObject.getAudioTracks().forEach(track => {\n                track.enabled = !track.enabled;\n                this.setState({\n                    remoteMuted: !track.enabled\n                });\n            });\n        }\n    }\n\n\n    /**\n     * Call allows you to call a remote user using their userId\n     * @param params {ICallParams}\n     */\n    call(params) {\n        this.core.call(params);\n    }\n\n    /**\n     * Handle the data stream for the caller\n     * @param streamData {string}\n     */\n    handleCallerStream(streamData) {\n        if (typeof streamData === 'string') {\n            streamData = JSON.parse(streamData);\n        }\n\n        if (streamData.candidate) {\n            if (typeof streamData.candidate === 'string') {\n                streamData.candidate = JSON.parse(streamData.candidate);\n            }\n            this.core.handleSenderStream({\n                Direction: \"Sender\",\n                Type: 0,\n                data: streamData.candidate\n            });\n\n        }\n\n        if (streamData.answer) {\n            const message = {\n                data: streamData.answer,\n                Direction: \"Sender\",\n                Type: 1\n\n            };\n            this.core.handleSenderStream(message);\n        }\n    }\n\n    /**\n     * Answer the call\n     * @param params {ICallParams}\n     */\n    answerCall(params) {\n        this.core.answerCall(params);\n        this.setState({\n            localMuted: false,\n            remoteMuted: false,\n            inProgress: true,\n            ringing: false\n        });\n    }\n    /**\n     * Reject the phone call\n     */\n    rejectCall() {\n        this.meteor.call(\"VideoCallServices/reject\", err => {\n            if (err) {\n                this.onError(err);\n            }\n            this.core.rejectCall();\n            this.setState({\n                localMuted: false,\n                remoteMuted: false,\n                inProgress: false,\n                ringing: false\n            });\n        });\n    }\n    /**\n     * End the call\n     */\n    endCall() {\n        this.meteor.call(\"VideoCallServices/end\", err => {\n            if (err) {\n                this.onError(err);\n            }\n            this.terminateCall();\n        });\n    }\n    /**\n     * Initialize the local video chat client\n     * @param rtcConfiguration {RTCConfiguration}\n     * https://developer.mozilla.org/en-US/docs/Web/API/RTCConfiguration\n     */\n    init(rtcConfiguration) {\n        this.core.init(rtcConfiguration);\n    }\n    terminateCall() {\n        this.setState({\n            localMuted: false,\n            remoteMuted: false,\n            inProgress: false,\n            ringing: false\n        });\n        this.core.endCall();\n    }\n\n    onTargetAccept() {\n\n    }\n\n    onReceiveCall(fields) {\n\n    }\n\n    onTerminateCall() {\n\n    }\n    onPeerConnectionCreated() {\n\n    }\n    onCallRejected() {\n\n    }\n    setOnError(callback) {\n        this.core.on('error', callback);\n    }\n    onError(err) {\n        this.core.events.callEvent(\"error\")(err);\n    }\n    onReceiveCall() {\n\n    }\n\n\n}\n\nexport {\n    VideoCallServices\n};\n","export const MeteorVideoChat = ({\n    Meteor,\n    MeteorClient,\n    Tracker,\n    CoreClient,\n    ReactiveVar,\n    ddp,\n    Streamer\n}) => {\n\n\n        const core = new CoreClient({});\n        core.on('emitIceCandidate', iceCandidate =>\n            Meteor.VideoCallServices.stream.emit('video_message', JSON.stringify({ candidate: iceCandidate }))\n        );\n        core.on('emitTargetAnswer', answer =>\n            Meteor.VideoCallServices.stream.emit('video_message', JSON.stringify({ answer }))\n        );\n        core.on('callInitialized', (params) =>\n            Meteor.call('VideoCallServices/call', params.id,\n                (err, _id) => {})\n        );\n        core.on('endCall', () => {\n            Meteor.VideoCallServices.onTerminateCall();\n        });\n        core.on('answerCall', () => {\n            Meteor.call('VideoCallServices/answer', err => {\n                if (err) {\n                    core.events.callEvent(\"error\")(err);\n                }\n                Meteor.VideoCallServices.setState({\n                    localMuted: false,\n                    remoteMuted: false,\n                    inProgress: true,\n                    ringing: false\n                });\n            });\n        });\n        core.on('emitSenderDescription', sessionDescription =>\n            Meteor.VideoCallServices.stream.emit('video_message', JSON.stringify({ offer: sessionDescription }))\n        );\n        core.on('error', err => console.log(\"error\", err));\n\n        const VideoCallServices = new MeteorClient({\n            meteor: Meteor,\n            tracker: Tracker,\n            core,\n            reactiveVar: ReactiveVar,\n            ddp,\n            Streamer\n        });\n        Meteor.VideoCallServices = VideoCallServices;\n        core.on('recieveCall', VideoCallServices.onReceiveCall);\n        core.on('peerConnectionCreated', VideoCallServices.onPeerConnectionCreated);\n        Meteor.VideoCallServices.setOnError = function(onError) {\n            CoreClient.prototype.onError = onError;\n        };\n   \n        return VideoCallServices\n        \n    \n};\n"]}