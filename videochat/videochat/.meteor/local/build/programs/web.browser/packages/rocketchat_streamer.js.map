{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:streamer/lib/ev.js","meteor://ðŸ’»app/packages/rocketchat:streamer/client/client.js"],"names":["EV","constructor","handlers","emit","event","args","forEach","handler","apply","emitWithScope","scope","on","callback","push","once","self","onetimeCallback","arguments","removeListener","index","indexOf","splice","removeAllListeners","undefined","NonEmptyString","Match","Where","x","check","String","length","StreamerCentral","instances","ddpConnections","setupDdpConnection","name","ddpConnection","hasMeteorStreamerEventListeners","_stream","raw_msg","msg","DDPCommon","parseDDP","collection","fields","eventName","unshift","storeDdpConnection","Meteor","Streamer","useCollection","connection","console","warn","subscriptions","subscriptionName","lastMessage","call","_name","_useCollection","Boolean","stop","subscription","unsubscribe","stopAll","hasOwnProperty","subscribe","Tracker","nonreactive","onStop","onReconnect","fn","getLastMessageFromEvent","pop","Function"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\tif (this.handlers[event]) {\n\t\t\tthis.handlers[event].forEach((handler) => handler.apply(this, args));\n\t\t}\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\tif (this.handlers[event]) {\n\t\t\tthis.handlers[event].forEach((handler) => handler.apply(scope, args));\n\t\t}\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tself = this;\n\t\tself.on(event, function onetimeCallback() {\n\t\t\tcallback.apply(this, arguments);\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif(this.handlers[event]) {\n\t\t\tconst index = this.handlers[event].indexOf(callback);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.handlers[event].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals DDPCommon, EV */\n/* eslint-disable new-cap */\n\nconst NonEmptyString = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn x.length > 0;\n});\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t\tthis.ddpConnections = {};\t\t// since each Streamer instance can provide its own ddp connection, store them by streamer name\n\n\t}\n\n\tsetupDdpConnection(name, ddpConnection) {\n\t\t// make sure we only setup event listeners for each ddp connection once\n\t\tif (ddpConnection.hasMeteorStreamerEventListeners) {\n\t\t\treturn;\n\t\t}\n\t\tddpConnection._stream.on('message', (raw_msg) => {\n\t\t\tconst msg = DDPCommon.parseDDP(raw_msg);\n\t\t\tif (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n\t\t\t\tmsg.fields.args.unshift(msg.fields.eventName);\n\t\t\t\tmsg.fields.args.unshift(msg.collection);\n\t\t\t\tthis.emit.apply(this, msg.fields.args);\n\t\t\t}\n\t\t});\n\t\t// store ddp connection\n\t\tthis.storeDdpConnection(name, ddpConnection);\n\n\t}\n\n\tstoreDdpConnection(name, ddpConnection) {\n\t\t// mark the connection as setup for Streamer, and store it\n\t\tddpConnection.hasMeteorStreamerEventListeners = true;\n\t\tthis.ddpConnections[name] = ddpConnection;\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {useCollection = false, ddpConnection = Meteor.connection } = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\t\tMeteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n\n\t\tsuper();\n\n\t\tthis.ddpConnection = ddpConnection || Meteor.connection;\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.useCollection = useCollection;\n\t\tthis.subscriptions = {};\n\n\t\tMeteor.StreamerCentral.on(this.subscriptionName, (eventName, ...args) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\tthis.subscriptions[eventName].lastMessage = args;\n\t\t\t\tsuper.emit.call(this, eventName, ...args);\n\t\t\t}\n\t\t});\n\n\t\tthis.ddpConnection._stream.on('reset', () => {\n\t\t\tsuper.emit.call(this, '__reconnect__');\n\t\t});\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget useCollection() {\n\t\treturn this._useCollection;\n\t}\n\n\tset useCollection(useCollection) {\n\t\tcheck(useCollection, Boolean);\n\t\tthis._useCollection = useCollection;\n\t}\n\n\tstop(eventName) {\n\t\tif (this.subscriptions[eventName] && this.subscriptions[eventName].subscription) {\n\t\t\tthis.subscriptions[eventName].subscription.stop();\n\t\t}\n\t\tthis.unsubscribe(eventName);\n\t}\n\n\tstopAll() {\n\t\tfor (let eventName in this.subscriptions) {\n\t\t\tif (this.subscriptions.hasOwnProperty(eventName)) {\n\t\t\t\tthis.stop(eventName);\n\t\t\t}\n\t\t}\n\t}\n\n\tunsubscribe(eventName) {\n\t\tthis.removeAllListeners(eventName);\n\t\tdelete this.subscriptions[eventName];\n\t}\n\n\tsubscribe(eventName, args) {\n\t\tlet subscribe;\n\t\tTracker.nonreactive(() => {\n\t\t\tsubscribe = this.ddpConnection.subscribe(this.subscriptionName, eventName, { useCollection: this.useCollection, args }, {\n\t\t\t\tonStop: () => {\n\t\t\t\t\tthis.unsubscribe(eventName);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\treturn subscribe;\n\t}\n\n\tonReconnect(fn) {\n\t\tif (typeof fn === 'function') {\n\t\t\tsuper.on('__reconnect__', fn);\n\t\t}\n\t}\n\n\tgetLastMessageFromEvent(eventName) {\n\t\tconst subscription = this.subscriptions[eventName];\n\t\tif (subscription && subscription.lastMessage) {\n\t\t\treturn subscription.lastMessage;\n\t\t}\n\t}\n\n\tonce(eventName, ...args) {\n\t\tconst callback = args.pop();\n\n\t\tcheck(eventName, NonEmptyString);\n\t\tcheck(callback, Function);\n\n\t\tif (!this.subscriptions[eventName]) {\n\t\t\tthis.subscriptions[eventName] = {\n\t\t\t\tsubscription: this.subscribe(eventName, args)\n\t\t\t};\n\t\t}\n\n\t\tsuper.once(eventName, callback);\n\t}\n\n\ton(eventName, ...args) {\n\t\tconst callback = args.pop();\n\n\t\tcheck(eventName, NonEmptyString);\n\t\tcheck(callback, Function);\n\n\t\tif (!this.subscriptions[eventName]) {\n\t\t\tthis.subscriptions[eventName] = {\n\t\t\t\tsubscription: this.subscribe(eventName, args)\n\t\t\t};\n\t\t}\n\n\t\tsuper.on(eventName, callback);\n\t}\n\n\temit(...args) {\n\t\tthis.ddpConnection.call(this.subscriptionName, ...args);\n\t}\n};\n"]}